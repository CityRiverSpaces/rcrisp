<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>3. Preparing the network for delineation â€¢ rcrisp</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="3. Preparing the network for delineation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rcrisp</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.4</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/vig_01-method.html">The method</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Preparation</h6></li>
    <li><a class="dropdown-item" href="../articles/vig_02-getting-osm-data.html">Getting OSM data for delineation</a></li>
    <li><a class="dropdown-item" href="../articles/vig_03-network-preparation.html">Preparing the network for delineation</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Delineation</h6></li>
    <li><a class="dropdown-item" href="../articles/vig_04-valley-delineation.html">Valley delineation</a></li>
    <li><a class="dropdown-item" href="../articles/vig_05-corridor-delineation.html">Corridor delineation</a></li>
    <li><a class="dropdown-item" href="../articles/vig_06-corridor-segmentation.html">Corridor segmentation</a></li>
    <li><a class="dropdown-item" href="../articles/vig_07-riverspace-delineation.html">Riverspace delineation</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/CityRiverSpaces/rcrisp/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>3. Preparing the network for delineation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/CityRiverSpaces/rcrisp/blob/main/vignettes/vig_03-network-preparation.Rmd" class="external-link"><code>vignettes/vig_03-network-preparation.Rmd</code></a></small>
      <div class="d-none name"><code>vig_03-network-preparation.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cityriverspaces.github.io/rcrisp/">rcrisp</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in check_cache(): Cache dir: /home/runner/.cache/R/rcrisp - size: 12 MB - oldest file from: 2025-07-31.</span></span>
<span><span class="co">#&gt; Clean up files older than 30 days with: `rcrisp::clear_cache('2025-07-01')` (or remove all cached files with: `rcrisp::clear_cache()`.</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://luukvdmeer.github.io/sfnetworks/" class="external-link">sfnetworks</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">bucharest_osm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_osm_example_data.html">get_osm_example_data</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">bucharest_dem</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_dem_example_data.html">get_dem_example_data</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="input-data">1. Input data<a class="anchor" aria-label="anchor" href="#input-data"></a>
</h2>
<p>In this article we show how to set up the spatial network for a city
before using it for urban river corridor delineation. We work with the
OSM data for the city of Bucharest provided in rcrisp example data. See
how to get your own OSM data in
<code>vignette("getting-osm-data")</code>.</p>
<p>We start by loading the OSM data. According to the delineation
method, all persistent physical structures need to be considered.
Therefore, the network will contain both streets and railways from
OSM.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">streets</span> <span class="op">&lt;-</span> <span class="va">bucharest_osm</span><span class="op">$</span><span class="va">streets</span></span>
<span><span class="va">railways</span> <span class="op">&lt;-</span> <span class="va">bucharest_osm</span><span class="op">$</span><span class="va">railways</span></span></code></pre></div>
<p><strong>Note</strong>: If the city in question contains other
surface-level structures that need to be included in the network, such
as above-ground metro lines, retrieve them with the appropriate OSM tags
following the instructions in <code>vignette("getting-osm-data")</code>
and include them here in the network.</p>
</div>
<div class="section level2">
<h2 id="setting-up-the-network">2. Setting up the network<a class="anchor" aria-label="anchor" href="#setting-up-the-network"></a>
</h2>
<p>After combining the streets and railway lines, we create a network
object.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">network</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">streets</span>, <span class="va">railways</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://luukvdmeer.github.io/sfnetworks/reference/as_sfnetwork.html" class="external-link">as_sfnetwork</a></span><span class="op">(</span>directed <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html" class="external-link">activate</a></span><span class="op">(</span><span class="st">"nodes"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>node_id <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>To be able to use the network for delineation, we need to flatten it
(that is, project bridges to the ground surface) and add nodes at all
intersections between edges.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">network_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flatten_network.html">flatten_network</a></span><span class="op">(</span><span class="va">network</span><span class="op">)</span></span></code></pre></div>
<p>The function above first identifies unique apparent intersections
between edges. Then it injects those points within the edge geometries
(linestrings), so that they can be raised as network nodes in the
cleaning step.</p>
<p><strong>Note</strong>: <code><a href="https://luukvdmeer.github.io/sfnetworks/reference/st_network_blend.html" class="external-link">sfnetworks::st_network_blend</a></code>
cannot be used for this purpose, because this function only adds
external points to one edge (the closest one).</p>
</div>
<div class="section level2">
<h2 id="network-cleaning">3. Network cleaning<a class="anchor" aria-label="anchor" href="#network-cleaning"></a>
</h2>
<p>We now perform standard cleaning tasks on the network: subdividing
edges by adding missing nodes, removing pseudo-nodes and keeping only
the main component of the network.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">network_cleaned</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clean_network.html">clean_network</a></span><span class="op">(</span><span class="va">network_new</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="visualise-cleaned-network">4. Visualise cleaned network<a class="anchor" aria-label="anchor" href="#visualise-cleaned-network"></a>
</h2>
<p>Visualize cleaned network:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">network_new_nodes</span> <span class="op">&lt;-</span> <span class="va">network_cleaned</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html" class="external-link">activate</a></span><span class="op">(</span><span class="st">"nodes"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">node_id</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html" class="external-link">activate</a></span><span class="op">(</span><span class="st">"edges"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">from</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">to</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">network_removed_nodes</span> <span class="op">&lt;-</span> <span class="va">network</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html" class="external-link">activate</a></span><span class="op">(</span><span class="st">"nodes"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">node_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="op">(</span><span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html" class="external-link">activate</a></span><span class="op">(</span><span class="va">network_cleaned</span>, <span class="st">"nodes"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>                          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">node_id</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html" class="external-link">activate</a></span><span class="op">(</span><span class="st">"edges"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">from</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">to</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">network</span>, col <span class="op">=</span> <span class="st">"grey50"</span>,</span>
<span>     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">425100</span>, <span class="fl">425400</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4922400</span>, <span class="fl">4923000</span><span class="op">)</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Network before preprocessing"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">network_cleaned</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html" class="external-link">activate</a></span><span class="op">(</span><span class="st">"nodes"</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"grey50"</span>,</span>
<span>     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">425100</span>, <span class="fl">425400</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4922400</span>, <span class="fl">4923000</span><span class="op">)</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Network after preprocessing"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">network_new_nodes</span>, col <span class="op">=</span> <span class="st">"darkgreen"</span>,</span>
<span>     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">425100</span>, <span class="fl">425400</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4922400</span>, <span class="fl">4923000</span><span class="op">)</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Network after preprocessing"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">network_removed_nodes</span>, col <span class="op">=</span> <span class="st">"red"</span>, pch <span class="op">=</span> <span class="fl">4</span>,</span>
<span>     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">425100</span>, <span class="fl">425400</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4922400</span>, <span class="fl">4923000</span><span class="op">)</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Network after preprocessing"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="vig_03-network-preparation_files/figure-html/unnamed-chunk-6-1.png" alt="The network before and after preprocessing." width="700"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Claudiu Forgaci, Francesco Nattino, Netherlands eScience Center.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
